<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VISA Optimizer Pro</title>
    <script src="https://unpkg.com/tesseract.js@4.0.1/dist/tesseract.min.js"></script>
    <style>
        :root { --visa-blue: #0033a0; --success: #28a745; --danger: #dc3545; --warning: #ffc107; }
        body { font-family: -apple-system, system-ui, sans-serif; background: #f0f2f5; margin: 0; padding: 15px; color: #333; }
        .header-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .lang-switch button { padding: 5px 10px; border: 1px solid #ddd; background: white; border-radius: 15px; font-size: 12px; }
        .lang-switch button.active { background: var(--visa-blue); color: white; }
        
        h2 { color: var(--visa-blue); margin: 0; font-size: 1.3em; }
        .card { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 12px; }
        
        .input-group { display: flex; gap: 8px; margin-bottom: 10px; }
        input { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; outline: none; }
        
        button { padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .btn-scan { background: #eef2ff; color: var(--visa-blue); border: 1px dashed var(--visa-blue); width: 100%; margin-bottom: 10px; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-add { background: var(--visa-blue); color: white; width: 100%; }
        .btn-calc { background: var(--success); color: white; width: 100%; font-size: 1.1em; margin-top: 10px; }

        .list-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        ul { list-style: none; padding: 0; margin: 0; }
        li { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #f9f9f9; font-size: 14px; }
        .item-info { flex: 1; display: flex; justify-content: space-between; margin-right: 15px; cursor: pointer; }
        .btn-delete { color: var(--danger); background: none; padding: 5px; font-size: 16px; }

        .result-group { border-left: 6px solid var(--visa-blue); padding: 12px; margin-top: 12px; background: #fff; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .status-ok { border-color: var(--success); }
        .status-fail { border-color: var(--warning); background: #fff9e6; }
        
        .badge { display: inline-block; padding: 3px 8px; border-radius: 10px; font-size: 0.7em; font-weight: bold; margin-bottom: 5px; }
        .badge-ok { background: var(--success); color: white; }
        .badge-fail { background: var(--warning); color: #856404; }
        
        .suggestion { font-size: 0.85em; color: var(--danger); font-weight: bold; margin-top: 5px; display: block; }
        .twd-hint { font-size: 0.8em; color: #888; }
        #ocrStatus { font-size: 0.8em; text-align: center; margin-bottom: 5px; min-height: 1.2em; }
    </style>
</head>
<body>

    <div class="header-bar">
        <h2 id="ui-title">ğŸ’³ VISA æ¹Šåƒç²¾ç®—å¸«</h2>
        <div class="lang-switch">
            <button id="btn-zh" class="active" onclick="setLang('zh')">ç¹ä¸­</button>
            <button id="btn-ja" onclick="setLang('ja')">æ—¥æœ¬èª</button>
        </div>
    </div>

    <div class="card">
        <div id="ocrStatus"></div>
        <input type="file" id="cameraInput" accept="image/*" capture="environment" style="display: none;">
        <button class="btn-scan" onclick="document.getElementById('cameraInput').click()">
            <span>ğŸ“·</span> <span id="ui-scanBtn">æ‹ç…§è¾¨è­˜åƒ¹æ ¼</span>
        </button>
        
        <div class="input-group">
            <input type="text" id="itemName" placeholder="å“é …åç¨±">
            <input type="number" id="itemPrice" placeholder="é‡‘é¡" inputmode="decimal">
        </div>
        <button class="btn-add" id="ui-addBtn" onclick="addItem()">ï¼‹ åŠ å…¥æ¸…å–®</button>
    </div>

    <div class="card">
        <div class="list-header">
            <h3 id="ui-listTitle" style="margin:0; font-size: 1em;">ç›®å‰æ¸…å–®</h3>
            <div style="text-align: right">
                <span id="ui-totalLabel">ç¸½é¡</span>: Â¥<span id="totalDisplay">0</span>
                <div class="twd-hint">â‰ˆ NT$ <span id="totalTWD">0</span></div>
            </div>
        </div>
        <ul id="itemList"></ul>
        <button class="btn-calc" id="ui-calcBtn" onclick="calculateGroups()">âš™ï¸ åŸ·è¡Œç²¾æº–åˆ†çµ„</button>
    </div>

    <div id="results"></div>

    <script>
        const i18n = {
            zh: {
                title: 'ğŸ’³ VISA æ¹Šåƒç²¾ç®—å¸«',
                scanBtn: 'æ‹ç…§è¾¨è­˜åƒ¹æ ¼',
                placeholderName: 'å“é …åç¨±',
                placeholderPrice: 'é‡‘é¡',
                addBtn: 'ï¼‹ åŠ å…¥æ¸…å–®',
                listTitle: 'å¾…è™•ç†æ¸…å–®',
                totalLabel: 'ç¸½é¡',
                calcBtn: 'âš™ï¸ åŸ·è¡Œç²¾æº–åˆ†çµ„',
                groupName: 'çµ„åˆ {n}',
                qualified: 'âœ… é”æ¨™ (å¯æŠ½ç)',
                unqualified: 'âš ï¸ æœªé”æ¨™',
                suggest: 'ğŸ’¡ å†æ¹Š Â¥{m} å³å¯å¤šæŠ½ä¸€æ¬¡ï¼',
                ocrLoading: 'è¾¨è­˜ä¸­...',
                unnamed: 'å•†å“'
            },
            ja: {
                title: 'ğŸ’³ VISA 1000å††ç²¾ç®—æ©Ÿ',
                scanBtn: 'ä¾¡æ ¼ã‚’ã‚¹ã‚­ãƒ£ãƒ³',
                placeholderName: 'å•†å“å',
                placeholderPrice: 'é‡‘é¡',
                addBtn: 'ï¼‹ è¿½åŠ ',
                listTitle: 'è²·ã„ç‰©ãƒªã‚¹ãƒˆ',
                totalLabel: 'åˆè¨ˆ',
                calcBtn: 'âš™ï¸ ç²¾å¯†ã‚°ãƒ«ãƒ¼ãƒ—åˆ†ã‘',
                groupName: 'ã‚°ãƒ«ãƒ¼ãƒ— {n}',
                qualified: 'âœ… é”æˆ (æŠ½é¸å¯¾è±¡)',
                unqualified: 'âš ï¸ æœªé”æˆ',
                suggest: 'ğŸ’¡ ã‚ã¨ Â¥{m} ã§æŠ½é¸æ¨©ç¢ºå®šï¼',
                ocrLoading: 'èª­ã¿å–ã‚Šä¸­...',
                unnamed: 'ã‚¢ã‚¤ãƒ†ãƒ '
            }
        };

        let currentLang = 'zh';
        let items = []; // å„²å­˜æ ¼å¼: { id, name, price }
        const TARGET = 1000;
        const RATE = 0.215;

        function setLang(lang) {
            currentLang = lang;
            document.querySelectorAll('.lang-switch button').forEach(b => b.classList.remove('active'));
            document.getElementById(`btn-${lang}`).classList.add('active');
            const d = i18n[lang];
            document.getElementById('ui-title').innerText = d.title;
            document.getElementById('ui-scanBtn').innerText = d.scanBtn;
            document.getElementById('itemName').placeholder = d.placeholderName;
            document.getElementById('itemPrice').placeholder = d.placeholderPrice;
            document.getElementById('ui-addBtn').innerText = d.addBtn;
            document.getElementById('ui-listTitle').innerText = d.listTitle;
            document.getElementById('ui-totalLabel').innerText = d.totalLabel;
            document.getElementById('ui-calcBtn').innerText = d.calcBtn;
            updateUI();
        }

        // --- æ¸…å–®ç®¡ç† ---
        function addItem() {
            const nameInput = document.getElementById('itemName');
            const priceInput = document.getElementById('itemPrice');
            const name = nameInput.value || i18n[currentLang].unnamed;
            const price = parseFloat(priceInput.value);
            
            if (!price) return;

            items.push({ id: Date.now() + Math.random(), name, price });
            nameInput.value = "";
            priceInput.value = "";
            updateUI();
        }

        function deleteItem(id) {
            items = items.filter(item => item.id !== id);
            updateUI();
        }

        function editItem(id) {
            const item = items.find(i => i.id === id);
            if (item) {
                document.getElementById('itemName').value = item.name;
                document.getElementById('itemPrice').value = item.price;
                deleteItem(id); // å…ˆç§»é™¤ï¼Œä¿®æ”¹å¾Œå†æŒ‰ã€ŒåŠ å…¥æ¸…å–®ã€
            }
        }

        function updateUI() {
            const listEl = document.getElementById('itemList');
            let total = items.reduce((s, i) => s + i.price, 0);
            document.getElementById('totalDisplay').innerText = total.toLocaleString();
            document.getElementById('totalTWD').innerText = Math.round(total * RATE).toLocaleString();
            
            listEl.innerHTML = items.map(i => `
                <li>
                    <div class="item-info" onclick="editItem(${i.id})">
                        <span>${i.name}</span>
                        <span>Â¥${i.price.toLocaleString()}</span>
                    </div>
                    <button class="btn-delete" onclick="deleteItem(${i.id})">ğŸ—‘ï¸</button>
                </li>
            `).join('');
            
            // æ¯æ¬¡æ›´æ–°æ¸…å–®æ™‚ï¼Œæ¸…ç©ºèˆŠçš„è¨ˆç®—çµæœ
            document.getElementById('results').innerHTML = "";
        }

        // --- ç²¾æº–åˆ†çµ„æ¼”ç®—æ³• (æ ¸å¿ƒä¿®æ­£) ---
        function calculateGroups() {
            if (items.length === 0) return;
            
            let pool = [...items];
            let groups = [];

            while (pool.length > 0) {
                let bestCombination = getBestCombination(pool, TARGET);
                if (bestCombination.items.length === 0) break;
                
                groups.push(bestCombination);
                
                const usedIds = bestCombination.items.map(i => i.id);
                pool = pool.filter(i => !usedIds.includes(i.id));
            }
            renderResults(groups);
        }

        function getBestCombination(remaining, target) {
            // å¦‚æœå‰©ä¸‹ç¸½é¡ä¸è¶³ 1000ï¼Œç›´æ¥å…¨éƒ¨æ­¸ä¸€çµ„
            const currentTotal = remaining.reduce((s, i) => s + i.price, 0);
            if (currentTotal < target) {
                return { items: [...remaining], sum: currentTotal };
            }

            let bestItems = [];
            let minExcess = Infinity;

            // æ·±åº¦å„ªå…ˆæœå°‹ (DFS) å°‹æ‰¾æœ€æ¥è¿‘ä¸”å¤§æ–¼ 1000 çš„çµ„åˆ
            function dfs(index, currentItems, currentSum) {
                if (currentSum >= target) {
                    if (currentSum - target < minExcess) {
                        minExcess = currentSum - target;
                        bestItems = [...currentItems];
                    }
                    return;
                }
                if (index >= remaining.length || (currentSum - target) > minExcess) return;

                // é¸
                currentItems.push(remaining[index]);
                dfs(index + 1, currentItems, currentSum + remaining[index]);
                currentItems.pop();
                
                // ä¸é¸
                dfs(index + 1, currentItems, currentSum);
            }

            dfs(0, [], 0);
            
            // å®‰å…¨æ©Ÿåˆ¶ï¼šå¦‚æœ DFS æ²’æ‰¾åˆ°ï¼ˆç†è«–ä¸Šä¸æœƒï¼‰ï¼Œå°±éš¨ä¾¿æ‹¿ä¸€å€‹
            if (bestItems.length === 0 && remaining.length > 0) {
                bestItems = [remaining[0]];
            }

            return { items: bestItems, sum: bestItems.reduce((s, i) => s + i.price, 0) };
        }

        function renderResults(groups) {
            const resDiv = document.getElementById('results');
            resDiv.innerHTML = `<h3 style="margin-left:5px; font-size: 1.1em;">ğŸ“Š åˆ†çµ„å»ºè­°çµæœ</h3>`;
            
            groups.forEach((g, idx) => {
                const ok = g.sum >= TARGET;
                const dict = i18n[currentLang];
                const div = document.createElement('div');
                div.className = `result-group ${ok ? 'status-ok' : 'status-fail'}`;
                
                let suggestMsg = "";
                if (!ok) {
                    suggestMsg = `<span class="suggestion">${dict.suggest.replace('{m}', TARGET - g.sum)}</span>`;
                }

                div.innerHTML = `
                    <span class="badge ${ok ? 'badge-ok' : 'badge-fail'}">${ok ? dict.qualified : dict.unqualified}</span>
                    <strong style="display:block; font-size: 1.1em;">${dict.groupName.replace('{n}', idx+1)}: Â¥${g.sum.toLocaleString()}</strong>
                    <div class="twd-hint">â‰ˆ NT$ ${Math.round(g.sum * RATE).toLocaleString()}</div>
                    <small style="display:block; color: #666; margin-top:5px; border-top: 1px dashed #ddd; padding-top:5px;">
                        ${g.items.map(i => i.name).join(' + ')}
                    </small>
                    ${suggestMsg}
                `;
                resDiv.appendChild(div);
            });
        }

        // --- OCR æ‹ç…§è¾¨è­˜ ---
        document.getElementById('cameraInput').addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (!file) return;
            document.getElementById('ocrStatus').innerText = i18n[currentLang].ocrLoading;
            try {
                const { data: { text } } = await Tesseract.recognize(file, 'eng+chi_tra+jpn');
                const lines = text.split('\n');
                for (let l of lines) {
                    const m = l.match(/\d+/);
                    if (m && parseInt(m[0]) > 10) {
                        document.getElementById('itemPrice').value = m[0];
                        document.getElementById('itemName').value = l.replace(m[0], '').replace(/[^\w\u4e00-\u9fa5\u3040-\u30ff\u3400-\u4dbf]/g, '').trim().substring(0,10);
                        break;
                    }
                }
                document.getElementById('ocrStatus').innerText = "âœ… è¾¨è­˜å®Œæˆ";
            } catch (err) {
                document.getElementById('ocrStatus').innerText = "âŒ è¾¨è­˜å¤±æ•—";
            }
        });
    </script>
</body>
</html>
