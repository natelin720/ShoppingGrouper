<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VISA Optimizer Max</title>
    <style>
        :root { --visa-blue: #0033a0; --success: #28a745; --danger: #dc3545; --warning: #ffc107; }
        body { font-family: -apple-system, system-ui, sans-serif; background: #f0f2f5; margin: 0; padding: 10px; color: #333; }
        .header-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .lang-switch button { padding: 5px 10px; border: 1px solid #ddd; background: white; border-radius: 15px; font-size: 12px; }
        .lang-switch button.active { background: var(--visa-blue); color: white; border-color: var(--visa-blue); }
        
        h2 { color: var(--visa-blue); margin: 0; font-size: 1.2em; }
        .card { background: white; padding: 12px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 10px; }
        
        .input-row { display: flex; gap: 5px; margin-bottom: 8px; flex-wrap: wrap; }
        input, select { padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; outline: none; }
        .flex-2 { flex: 2; min-width: 120px; }
        .flex-1 { flex: 1; min-width: 70px; }
        
        button { padding: 10px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .btn-add { background: var(--visa-blue); color: white; width: 100%; margin-top: 5px; }
        .btn-calc { background: var(--success); color: white; width: 100%; font-size: 1.1em; margin-top: 10px; }
        
        ul { list-style: none; padding: 0; margin: 0; }
        li { display: flex; flex-direction: column; padding: 10px 0; border-bottom: 1px solid #f0f0f0; }
        .item-main { display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .item-detail { font-size: 0.8em; color: #777; margin-top: 2px; }
        .btn-del { color: #ccc; background: none; padding: 5px; font-size: 1.2em; }

        .result-group { border-left: 6px solid var(--visa-blue); padding: 12px; margin-top: 10px; background: #fff; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .status-ok { border-color: var(--success); }
        .status-fail { border-color: var(--warning); background: #fffdf5; }
        .badge { display: inline-block; padding: 3px 8px; border-radius: 12px; font-size: 0.7em; font-weight: bold; margin-bottom: 5px; }
        .badge-ok { background: var(--success); color: white; }
        .badge-fail { background: var(--warning); color: #856404; }
        .suggestion { font-size: 0.85em; color: var(--danger); font-weight: bold; display: block; margin-top: 5px; }
    </style>
</head>
<body>

    <div class="header-bar">
        <h2 id="ui-title">üí≥ VISA 1000ÂÜÜÁ≤æÁÆóÊ©ü</h2>
        <div class="lang-switch">
            <button id="btn-zh" onclick="setLang('zh')">ÁπÅ‰∏≠</button>
            <button id="btn-ja" class="active" onclick="setLang('ja')">Êó•Êú¨Ë™û</button>
        </div>
    </div>

    <div class="card">
        <div class="input-row">
            <input type="text" id="itemName" class="flex-2" placeholder="ÂïÜÂìÅÂêç">
            <input type="number" id="itemPrice" class="flex-1" placeholder="Âçò‰æ°" inputmode="decimal">
        </div>
        <div class="input-row">
            <input type="number" id="itemQty" class="flex-1" value="1" min="1" placeholder="Êï∞Èáè">
            <select id="itemDiscount" class="flex-1" onchange="toggleCustomDiscount()">
                <option value="1">Ââ≤Âºï„Å™„Åó</option>
                <option value="0.9">10% OFF</option>
                <option value="0.8">20% OFF</option>
                <option value="0.7">30% OFF</option>
                <option value="0.5">50% OFF</option>
                <option value="custom">„Ç´„Çπ„Çø„É†</option>
            </select>
            <input type="number" id="customDiscount" class="flex-1" style="display:none" placeholder="‰æã: 85 (%)">
        </div>
        <button class="btn-add" id="ui-addBtn" onclick="addItem()">Ôºã ËøΩÂä†</button>
    </div>

    <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
            <h3 id="ui-listTitle" style="margin:0; font-size: 0.95em;">Ë≤∑„ÅÑÁâ©„É™„Çπ„Éà</h3>
            <div style="text-align: right; font-size: 0.85em;">
                <span id="ui-totalLabel">ÂêàË®à (Ââ≤ÂºïÂæå)</span>: ¬•<span id="totalDisplay">0</span>
                <div style="color: #888;">‚âà NT$ <span id="totalTWD">0</span></div>
            </div>
        </div>
        <ul id="itemList"></ul>
        <button class="btn-calc" id="ui-calcBtn" onclick="calculateGroups()">‚öôÔ∏è Á≤æÂØÜ„Ç∞„É´„Éº„ÉóÂàÜ„Åë</button>
        <button onclick="clearAll()" style="width:100%; margin-top:8px; background:none; color:#999; font-size:0.75em; text-decoration: underline;">ÂÖ®„Å¶„ÇØ„É™„Ç¢ / Ê∏ÖÈô§ÂÖ®ÈÉ®</button>
    </div>

    <div id="results"></div>

    <script>
        const i18n = {
            zh: { title: 'üí≥ VISA ÊπäÂçÉÁ≤æÁÆóÂ∏´', placeholderName: 'ÂìÅÈ†ÖÂêçÁ®±', placeholderPrice: 'ÂñÆÂÉπ', addBtn: 'Ôºã Âä†ÂÖ•Ê∏ÖÂñÆ', listTitle: 'ÁõÆÂâçÊ∏ÖÂñÆ', totalLabel: 'Á∏ΩË®à (ÊäòÂæå)', calcBtn: '‚öôÔ∏è Âü∑Ë°åÁ≤æÊ∫ñÂàÜÁµÑ', groupName: 'ÁµÑÂêà {n}', qualified: '‚úÖ ÈÅîÊ®ô', unqualified: '‚ö†Ô∏è Êú™ÈÅîÊ®ô', suggest: 'üí° ÂÜçÊπä ¬•{m} Âç≥ÂèØÂ§öÊäΩ‰∏ÄÊ¨°ÔºÅ' },
            ja: { title: 'üí≥ VISA 1000ÂÜÜÁ≤æÁÆóÊ©ü', placeholderName: 'ÂïÜÂìÅÂêç', placeholderPrice: 'Âçò‰æ°', addBtn: 'Ôºã ËøΩÂä†', listTitle: 'Ë≤∑„ÅÑÁâ©„É™„Çπ„Éà', totalLabel: 'ÂêàË®à (Ââ≤ÂºïÂæå)', calcBtn: '‚öôÔ∏è Á≤æÂØÜ„Ç∞„É´„Éº„ÉóÂàÜ„Åë', groupName: '„Ç∞„É´„Éº„Éó {n}', qualified: '‚úÖ ÈÅîÊàê', unqualified: '‚ö†Ô∏è Êú™ÈÅîÊàê', suggest: 'üí° „ÅÇ„Å® ¬•{m} „ÅßÊäΩÈÅ∏Ê®©Á¢∫ÂÆöÔºÅ' }
        };

        let items = [];
        let currentLang = 'ja';
        const TARGET = 1000;
        const JPY_TWD_RATE = 0.215;

        // ÂàùÂßãÂåñÔºöÂæûÊú¨Âú∞ÂÑ≤Â≠òËÆÄÂèñË≥áÊñô
        window.onload = function() {
            const savedItems = localStorage.getItem('visa_optimizer_items');
            if (savedItems) {
                items = JSON.parse(savedItems);
            }
            const savedLang = localStorage.getItem('visa_optimizer_lang');
            if (savedLang) {
                setLang(savedLang);
            } else {
                setLang('ja');
            }
        };

        function saveData() {
            localStorage.setItem('visa_optimizer_items', JSON.stringify(items));
            localStorage.setItem('visa_optimizer_lang', currentLang);
        }

        function toggleCustomDiscount() {
            const select = document.getElementById('itemDiscount');
            const customInput = document.getElementById('customDiscount');
            customInput.style.display = (select.value === 'custom') ? 'inline-block' : 'none';
        }

        function setLang(lang) {
            currentLang = lang;
            document.querySelectorAll('.lang-switch button').forEach(b => b.classList.remove('active'));
            document.getElementById(`btn-${lang}`).classList.add('active');
            const d = i18n[lang];
            document.getElementById('ui-title').innerText = d.title;
            document.getElementById('itemName').placeholder = d.placeholderName;
            document.getElementById('itemPrice').placeholder = d.placeholderPrice;
            document.getElementById('ui-addBtn').innerText = d.addBtn;
            document.getElementById('ui-listTitle').innerText = d.listTitle;
            document.getElementById('ui-totalLabel').innerText = d.totalLabel;
            document.getElementById('ui-calcBtn').innerText = d.calcBtn;
            saveData();
            renderList();
        }

        function addItem() {
            const name = document.getElementById('itemName').value || (currentLang === 'zh' ? 'È†ÖÁõÆ' : '„Ç¢„Ç§„ÉÜ„É†');
            const price = parseFloat(document.getElementById('itemPrice').value);
            const qty = parseInt(document.getElementById('itemQty').value) || 1;
            let discount = 1;

            const discVal = document.getElementById('itemDiscount').value;
            if (discVal === 'custom') {
                const customDisc = parseFloat(document.getElementById('customDiscount').value);
                if (!isNaN(customDisc)) discount = customDisc / 100;
            } else {
                discount = parseFloat(discVal);
            }

            if (!price) return;
            const singleFinalPrice = Math.round(price * discount);

            items.push({ id: Date.now(), name, price, qty, discount, singleFinalPrice });
            
            document.getElementById('itemName').value = '';
            document.getElementById('itemPrice').value = '';
            document.getElementById('itemQty').value = '1';
            document.getElementById('itemDiscount').value = '1';
            toggleCustomDiscount();
            saveData();
            renderList();
        }

        function deleteItem(id) {
            items = items.filter(i => i.id !== id);
            saveData();
            renderList();
        }

        function editItem(id) {
            const i = items.find(x => x.id === id);
            if (i) {
                document.getElementById('itemName').value = i.name;
                document.getElementById('itemPrice').value = i.price;
                document.getElementById('itemQty').value = i.qty;
                deleteItem(id);
            }
        }

        function clearAll() {
            const msg = currentLang === 'zh' ? "Á¢∫ÂÆöË¶ÅÊ∏ÖÈô§ÂÖ®ÈÉ®‰∏¶Âà™Èô§ÂÑ≤Â≠òÁ¥ÄÈåÑÂóéÔºü" : "ÂÖ®„Å¶„ÅÆ„Éá„Éº„Çø„ÇíÂâäÈô§„Åó„ÄÅ‰øùÂ≠òË®òÈå≤„Çí„ÇØ„É™„Ç¢„Åó„Åæ„Åô„ÅãÔºü";
            if(confirm(msg)) {
                items = [];
                localStorage.removeItem('visa_optimizer_items');
                renderList();
                document.getElementById('results').innerHTML = '';
            }
        }

        function renderList() {
            const listEl = document.getElementById('itemList');
            let total = items.reduce((s, i) => s + (i.singleFinalPrice * i.qty), 0);
            listEl.innerHTML = items.map(i => `
                <li>
                    <div class="item-main" onclick="editItem(${i.id})">
                        <strong>${i.name} x ${i.qty}</strong>
                        <span>¬•${(i.singleFinalPrice * i.qty).toLocaleString()}</span>
                    </div>
                    <div class="item-detail">
                        Âçò‰æ° ¬•${i.singleFinalPrice} ${i.discount < 1 ? `(${Math.round(i.discount*100)}%)` : ''} 
                        <button class="btn-del" style="float:right" onclick="deleteItem(${i.id})">üóëÔ∏è</button>
                    </div>
                </li>
            `).join('');
            document.getElementById('totalDisplay').innerText = total.toLocaleString();
            document.getElementById('totalTWD').innerText = Math.round(total * JPY_TWD_RATE).toLocaleString();
        }

        function calculateGroups() {
            if (items.length === 0) return;
            
            let flatPool = [];
            items.forEach(i => {
                for(let n=0; n<i.qty; n++) {
                    flatPool.push({ id: `${i.id}_${n}`, name: i.name, finalPrice: i.singleFinalPrice });
                }
            });
            
            let remaining = flatPool.sort((a, b) => b.finalPrice - a.price);
            let groups = [];
        
            while (true) {
                let bestGroup = null;
                function backtrack(start, currentGroup, currentSum) {
                    if (currentSum >= TARGET) {
                        if (!bestGroup || currentSum < bestGroup.sum) {
                            bestGroup = { items: [...currentGroup], sum: currentSum };
                        }
                        return;
                    }
                    for (let i = start; i < remaining.length; i++) {
                        currentGroup.push(remaining[i]);
                        backtrack(i + 1, currentGroup, currentSum + remaining[i].finalPrice);
                        currentGroup.pop();
                    }
                }
                backtrack(0, [], 0);
                if (!bestGroup) break;
                groups.push(bestGroup);
                const usedIds = new Set(bestGroup.items.map(i => i.id));
                remaining = remaining.filter(i => !usedIds.has(i.id));
            }
        
            if (remaining.length > 0) {
                groups.push({ items: remaining, sum: remaining.reduce((s, i) => s + i.finalPrice, 0) });
            }
            renderResultUI(groups);
        }

        function renderResultUI(groups) {
            const resDiv = document.getElementById('results');
            const d = i18n[currentLang];
            resDiv.innerHTML = `<h3 style="margin-left:5px">${d.calcBtn}</h3>`;

            groups.forEach((g, idx) => {
                const ok = g.sum >= TARGET;
                const div = document.createElement('div');
                div.className = `result-group ${ok ? 'status-ok' : 'status-fail'}`;
                
                const summary = g.items.reduce((acc, curr) => {
                    acc[curr.name] = (acc[curr.name] || 0) + 1;
                    return acc;
                }, {});
                const summaryText = Object.entries(summary).map(([name, count]) => `${name} x${count}`).join(' + ');

                div.innerHTML = `
                    <span class="badge ${ok ? 'badge-ok' : 'badge-fail'}">${ok ? d.qualified : d.unqualified}</span>
                    <strong style="display:block; font-size: 1.1em;">${d.groupName.replace('{n}', idx + 1)}: ¬•${g.sum.toLocaleString()}</strong>
                    <div style="font-size: 0.8em; color: #888;">‚âà NT$ ${Math.round(g.sum * JPY_TWD_RATE)}</div>
                    <div style="margin-top:5px; font-size: 0.8em; color: #666; border-top: 1px dashed #eee; padding-top:5px;">
                        ${summaryText}
                    </div>
                `;
                div.innerHTML += !ok ? `<span class="suggestion">${d.suggest.replace('{m}', TARGET - g.sum)}</span>` : '';
                resDiv.appendChild(div);
            });
            resDiv.scrollIntoView({ behavior: 'smooth' });
        }
    </script>
</body>
</html>
