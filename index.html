<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VISA Optimizer</title>
    <script src="https://unpkg.com/tesseract.js@4.0.1/dist/tesseract.min.js"></script>
    <style>
        :root { --visa-blue: #0033a0; --visa-gold: #f7b600; --success: #28a745; --danger: #dc3545; --light-bg: #f8f9fa; }
        body { font-family: -apple-system, system-ui, sans-serif; background: var(--light-bg); margin: 0; padding: 15px; color: #333; }
        
        /* é ‚éƒ¨å°èˆªèˆ‡èªè¨€åˆ‡æ› */
        .header-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .lang-switch button { padding: 6px 12px; border: 1px solid #ddd; background: white; border-radius: 20px; cursor: pointer; font-size: 14px; }
        .lang-switch button.active { background: var(--visa-blue); color: white; border-color: var(--visa-blue); }

        h2 { color: var(--visa-blue); margin: 0; font-size: 1.5em; }
        .card { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 15px; }
        
        /* è¼¸å…¥å€ */
        .input-group { display: flex; gap: 8px; margin-bottom: 10px; }
        input { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; outline: none; }
        input:focus { border-color: var(--visa-blue); }
        
        button { padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .btn-scan { background: #eef2ff; color: var(--visa-blue); border: 1px dashed var(--visa-blue); width: 100%; margin-bottom: 12px; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-add { background: var(--visa-blue); color: white; width: 100%; }
        .btn-calc { background: var(--success); color: white; width: 100%; font-size: 1.1em; margin-top: 10px; }

        /* æ¸…å–®æ¨£å¼ */
        .list-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; border-bottom: 2px solid #eee; padding-bottom: 5px; }
        ul { list-style: none; padding: 0; margin: 0; }
        li { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #f0f0f0; }
        .twd-hint { font-size: 0.8em; color: #888; margin-left: 5px; }

        /* åˆ†çµ„çµæœ */
        .result-group { border-left: 6px solid var(--visa-blue); padding: 12px; margin-top: 15px; background: #fff; border-radius: 8px; position: relative; }
        .status-ok { border-color: var(--success); background: #f0fff4; }
        .status-fail { border-color: var(--danger); background: #fff5f5; }
        .badge { display: inline-block; padding: 3px 10px; border-radius: 12px; font-size: 0.75em; font-weight: bold; margin-bottom: 5px; }
        .badge-ok { background: var(--success); color: white; }
        .badge-fail { background: var(--danger); color: white; }
        
        #ocrStatus { font-size: 0.85em; color: #666; text-align: center; margin-bottom: 8px; height: 1.2em; }
        .loading { color: var(--visa-blue); font-weight: bold; }
    </style>
</head>
<body>

    <div class="header-bar">
        <h2 id="ui-title">ğŸ’³ VISA æ¹Šåƒå°å¹«æ‰‹</h2>
        <div class="lang-switch">
            <button id="btn-zh" class="active" onclick="setLang('zh')">ç¹ä¸­</button>
            <button id="btn-ja" onclick="setLang('ja')">æ—¥æœ¬èª</button>
        </div>
    </div>

    <div class="card">
        <div id="ocrStatus"></div>
        <input type="file" id="cameraInput" accept="image/*" capture="environment" style="display: none;">
        <button class="btn-scan" onclick="document.getElementById('cameraInput').click()">
            <span>ğŸ“·</span> <span id="ui-scanBtn">æ‹ç…§è¾¨è­˜å“é …èˆ‡åƒ¹æ ¼</span>
        </button>
        
        <div class="input-group">
            <input type="text" id="itemName" placeholder="å“é …åç¨±">
            <input type="number" id="itemPrice" placeholder="é‡‘é¡" inputmode="decimal">
        </div>
        <button class="btn-add" id="ui-addBtn" onclick="addItem()">ï¼‹ åŠ å…¥æ¸…å–®</button>
    </div>

    <div class="card">
        <div class="list-header">
            <h3 id="ui-listTitle" style="margin:0">ç›®å‰æ¸…å–®</h3>
            <div style="text-align: right">
                <span id="ui-totalLabel">ç¸½è¨ˆ</span>: Â¥<span id="totalDisplay">0</span>
                <div class="twd-hint">â‰ˆ NT$ <span id="totalTWD">0</span></div>
            </div>
        </div>
        <ul id="itemList"></ul>
        <button class="btn-calc" id="ui-calcBtn" onclick="calculateGroups()">âš™ï¸ é–‹å§‹è‡ªå‹•åˆ†çµ„ (1000/çµ„)</button>
    </div>

    <div id="results"></div>

    <script>
        // --- å¤šèªç³»è¨­å®š ---
        const i18n = {
            zh: {
                title: 'ğŸ’³ VISA æ¹Šåƒå°å¹«æ‰‹',
                scanBtn: 'æ‹ç…§è¾¨è­˜å“é …èˆ‡åƒ¹æ ¼',
                placeholderName: 'å“é …åç¨±',
                placeholderPrice: 'é‡‘é¡',
                addBtn: 'ï¼‹ åŠ å…¥æ¸…å–®',
                listTitle: 'ç›®å‰æ¸…å–®',
                totalLabel: 'ç¸½è¨ˆ',
                calcBtn: 'âš™ï¸ é–‹å§‹è‡ªå‹•åˆ†çµ„ (1000/çµ„)',
                groupName: 'ç¬¬ {n} çµ„',
                qualified: 'âœ… å·²é”æŠ½çé–€æª»',
                unqualified: 'âŒ æœªé”æ¨™',
                ocrLoading: 'æ­£åœ¨è¾¨è­˜æ–‡å­—ä¸­...',
                ocrSuccess: 'âœ… è¾¨è­˜æˆåŠŸï¼',
                ocrFail: 'âŒ è¾¨è­˜å¤±æ•—',
                twdLabel: 'å°å¹£ç´„',
                unnamed: 'æœªå‘½åé …ç›®'
            },
            ja: {
                title: 'ğŸ’³ VISA 1000å††ã¾ã¨ã‚',
                scanBtn: 'å†™çœŸã§ä¾¡æ ¼ã‚’èª­ã¿å–ã‚‹',
                placeholderName: 'å•†å“å',
                placeholderPrice: 'é‡‘é¡',
                addBtn: 'ï¼‹ ãƒªã‚¹ãƒˆã«è¿½åŠ ',
                listTitle: 'ç¾åœ¨ã®ãƒªã‚¹ãƒˆ',
                totalLabel: 'åˆè¨ˆ',
                calcBtn: 'âš™ï¸ è‡ªå‹•ã‚°ãƒ«ãƒ¼ãƒ—åˆ†ã‘ (1000å††å˜ä½)',
                groupName: 'ã‚°ãƒ«ãƒ¼ãƒ— {n}',
                qualified: 'âœ… æŠ½é¸å¯¾è±¡',
                unqualified: 'âŒ æœªé”æˆ',
                ocrLoading: 'æ–‡å­—ã‚’èªè­˜ä¸­...',
                ocrSuccess: 'âœ… èª­ã¿å–ã‚ŠæˆåŠŸï¼',
                ocrFail: 'âŒ èª­ã¿å–ã‚Šå¤±æ•—',
                twdLabel: 'å°æ¹¾ãƒ‰ãƒ«ç´„',
                unnamed: 'å•†å“'
            }
        };

        let currentLang = 'zh';
        let items = [];
        const TARGET_AMOUNT = 1000;
        const JPY_TWD_RATE = 0.215; // åŒ¯ç‡ç¤ºä¾‹

        function setLang(lang) {
            currentLang = lang;
            document.querySelectorAll('.lang-switch button').forEach(b => b.classList.remove('active'));
            document.getElementById(`btn-${lang}`).classList.add('active');
            
            // æ›´æ–° UI æ–‡å­—
            const dict = i18n[lang];
            document.getElementById('ui-title').innerText = dict.title;
            document.getElementById('ui-scanBtn').innerText = dict.scanBtn;
            document.getElementById('itemName').placeholder = dict.placeholderName;
            document.getElementById('itemPrice').placeholder = dict.placeholderPrice;
            document.getElementById('ui-addBtn').innerText = dict.addBtn;
            document.getElementById('ui-listTitle').innerText = dict.listTitle;
            document.getElementById('ui-totalLabel').innerText = dict.totalLabel;
            document.getElementById('ui-calcBtn').innerText = dict.calcBtn;
            
            updateUI();
            if (document.getElementById('results').innerHTML !== "") calculateGroups();
        }

        // --- æ‹ç…§è¾¨è­˜é‚è¼¯ ---
        document.getElementById('cameraInput').addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const statusEl = document.getElementById('ocrStatus');
            statusEl.innerHTML = `<span class="loading">${i18n[currentLang].ocrLoading}</span>`;
            
            try {
                // é€™è£¡è¾¨è­˜ eng (æ•¸å­—) å’Œ chi_tra/jpn (åç¨±)
                const { data: { text } } = await Tesseract.recognize(file, 'eng+chi_tra+jpn');
                parseOcr(text);
            } catch (err) {
                statusEl.innerText = i18n[currentLang].ocrFail;
            }
        });

        function parseOcr(text) {
            const lines = text.split('\n');
            let foundPrice = 0;
            let foundName = "";

            for (let line of lines) {
                const match = line.match(/(\d{1,3}(,\d{3})*(\.\d+)?)/); 
                if (match) {
                    let price = parseFloat(match[0].replace(/,/g, ''));
                    if (price > 10) { 
                        foundPrice = price;
                        foundName = line.replace(match[0], '').replace(/[^\w\u4e00-\u9fa5\u3040-\u30ff\u3400-\u4dbf]/g, '').trim();
                        break;
                    }
                }
            }

            if (foundPrice > 0) {
                document.getElementById('itemName').value = foundName || i18n[currentLang].unnamed;
                document.getElementById('itemPrice').value = foundPrice;
                document.getElementById('ocrStatus').innerText = i18n[currentLang].ocrSuccess;
            } else {
                document.getElementById('ocrStatus').innerText = i18n[currentLang].ocrFail;
            }
        }

        // --- æ ¸å¿ƒé‚è¼¯ ---
        function addItem() {
            const name = document.getElementById('itemName').value || i18n[currentLang].unnamed;
            const price = parseFloat(document.getElementById('itemPrice').value);
            if (!price) return;

            items.push({ id: Date.now(), name, price });
            document.getElementById('itemName').value = "";
            document.getElementById('itemPrice').value = "";
            updateUI();
        }

        function updateUI() {
            const listEl = document.getElementById('itemList');
            const totalEl = document.getElementById('totalDisplay');
            const twdEl = document.getElementById('totalTWD');
            
            let total = items.reduce((sum, item) => sum + item.price, 0);
            totalEl.innerText = total.toLocaleString();
            twdEl.innerText = Math.round(total * JPY_TWD_RATE).toLocaleString();

            listEl.innerHTML = items.map(item => `
                <li>
                    <span>${item.name}</span>
                    <span>Â¥${item.price.toLocaleString()}</span>
                </li>
            `).join('');
        }

        function calculateGroups() {
            if (items.length === 0) return;
            
            // è²ªå©ªæ¼”ç®—æ³•ï¼šç”±å¤§åˆ°å°æ’åº
            let pool = [...items].sort((a, b) => b.price - a.price);
            let groups = [];

            while (pool.length > 0) {
                let currentGroup = [];
                let currentSum = 0;

                for (let i = 0; i < pool.length; i++) {
                    currentGroup.push(pool[i]);
                    currentSum += pool[i].price;
                    pool.splice(i, 1);
                    i--;
                    if (currentSum >= TARGET_AMOUNT) break;
                }
                groups.push({ items: currentGroup, sum: currentSum });
            }

            renderResults(groups);
        }

        function renderResults(groups) {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = `<h3 style="margin-left: 5px">${i18n[currentLang].listTitle} (Optimizer)</h3>`;

            groups.forEach((group, index) => {
                const ok = group.sum >= TARGET_AMOUNT;
                const dict = i18n[currentLang];
                const div = document.createElement('div');
                div.className = `result-group ${ok ? 'status-ok' : 'status-fail'}`;
                
                div.innerHTML = `
                    <span class="badge ${ok ? 'badge-ok' : 'badge-fail'}">
                        ${ok ? dict.qualified : dict.unqualified}
                    </span><br>
                    <strong>${dict.groupName.replace('{n}', index + 1)} - Â¥${group.sum.toLocaleString()}</strong>
                    <div class="twd-hint">â‰ˆ NT$ ${Math.round(group.sum * JPY_TWD_RATE).toLocaleString()}</div>
                    <small style="color: #666">${group.items.map(i => i.name).join(', ')}</small>
                `;
                resultsDiv.appendChild(div);
            });
        }
    </script>
</body>
</html>
